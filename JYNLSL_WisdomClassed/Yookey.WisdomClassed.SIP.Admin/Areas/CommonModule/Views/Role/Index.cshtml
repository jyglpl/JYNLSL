<!DOCTYPE html>

<html>
<head>
    <meta name="viewport" content="width=device-width" />
    <title>角色管理</title>
    <!--框架必需start-->
    <link href="@Url.Content("~/Content/Styles/learunui-startmenu.css")" rel="stylesheet" />
    <link href="@Url.Content("~/Content/Styles/learunui-accordion.css")" rel="stylesheet" />
    <link href="@Url.Content("~/Content/Styles/learunui-framework.css")" rel="stylesheet" />
    <script src="@Url.Content("~/Librarys/jquery/jquery-1.8.2.min.js")" type="text/javascript"></script>
    <script src="@Url.Content("~/Librarys/learunui-framework.js")"></script>
    <script src="@Url.Content("~/Content/Main/js/learunui-framework.js")"></script>
    <!--框架必需end-->
    <link href="@Url.Content("~/Librarys/casepic/css/style.css")" rel="stylesheet" />
    <!--jqgrid表格组件start-->
    <script src="@Url.Content("~/Librarys/jqgrid/jquery-ui-custom.min.js")"></script>
    <script src="@Url.Content("~/Librarys/jqgrid/grid.locale-cn.js")"></script>
    <link href="@Url.Content("~/Librarys/jqgrid/css/jqgrid.css")" rel="stylesheet" />
    <script src="@Url.Content("~/Librarys/jqgrid/jqGrid.js")"></script>
    <!--jqgrid表格组件end-->
    <!--树形组件start-->
    <link href="@Url.Content("~/Librarys/tree/tree.css")" rel="stylesheet" type="text/css" />
    <script src="@Url.Content("~/Librarys/tree/tree.js")" type="text/javascript"></script>
    <!--树形组件end-->
    <!--布局组件start-->
    <script src="@Url.Content("~/Librarys/layout/splitter.js")"></script>
    <!--布局组件end-->
    <!--日期组件start-->
    <script src="@Url.Content("~/Librarys/datepicker/WdatePicker.js")"></script>
    <!--日期组件end-->
    <!--引入弹窗组件start-->
    <script src="@Url.Content("~/Librarys/lhgdialog/lhgdialog.min.js")" type="text/javascript"></script>
    <!--引入弹窗组件end-->
    <script type="text/javascript">
        $(document).ready(function () {
            Loadlayout();
        });
    </script>
</head>
<body>
    <div>
        <div id="layout" class="layout">
            <!--左边-->
            <div class="layoutPanel layout-west">
                <div class="btnbartitle">
                    <div>
                        部门目录
                    </div>
                </div>
                <div class="ScrollBar" id="ItemsTree"></div>
            </div>
            <!--中间-->
            <div class="layoutPanel layout-center">
                <div class="btnbartitle">
                    <div>
                        角色列表<span id="CenterTitle"></span>
                    </div>
                </div>
                <div class="tools_bar" style="border-top: none; margin-bottom: 0px;">
                    <div class="PartialButton">
                        <a title="刷新当前(Ctrl+Q)" class="tools_btn" id="lr-replace" onclick="Replace()"><span><b style="background: url('@Url.Content("~/Content/Images/nav1.png")') 50% 8px no-repeat;background-size:18px 18px;-ms-behavior: url('@Url.Content("~/Content/Images/backgroundsize.min.htc")');behavior:url('@Url.Content("~/Content/Images/backgroundsize.min.htc")');">刷新</b></span></a>
                        <a title="新增(Ctrl+Z)" class="tools_btn" id="lr-add" onclick="btn_add()"><span><b style="background: url('@Url.Content("~/Content/Images/nav2.png")') 50% 8px no-repeat;background-size:18px 18px;-ms-behavior: url('@Url.Content("~/Content/Images/backgroundsize.min.htc")');behavior:url('@Url.Content("~/Content/Images/backgroundsize.min.htc")');">新增</b></span></a>
                        <a title="编辑(Ctrl+W)" class="tools_btn" id="lr-edit" onclick="btn_edit()"><span><b style="background: url('@Url.Content("~/Content/Images/nav3.png")') 50% 8px no-repeat;background-size:18px 18px;-ms-behavior: url('@Url.Content("~/Content/Images/backgroundsize.min.htc")');behavior:url('@Url.Content("~/Content/Images/backgroundsize.min.htc")');">编辑</b></span></a>
                        <a title="删除(Ctrl+S)" class="tools_btn" id="lr-delete" onclick="btn_delete()"><span><b style="background: url('@Url.Content("~/Content/Images/nav5.png")') 50% 8px no-repeat;background-size:18px 18px;-ms-behavior: url('@Url.Content("~/Content/Images/backgroundsize.min.htc")');behavior:url('@Url.Content("~/Content/Images/backgroundsize.min.htc")');">删除</b></span></a>
                        <a title="详细信息(Ctrl+X)" class="tools_btn" id="lr-detail" onclick="btn_detail()"><span><b style="background: url('@Url.Content("~/Content/Images/nav4.png")') 50% 8px no-repeat;background-size:18px 18px;-ms-behavior: url('@Url.Content("~/Content/Images/backgroundsize.min.htc")');behavior:url('@Url.Content("~/Content/Images/backgroundsize.min.htc")');">明细</b></span></a>
                        <a class="tools_btn dropdown" id="lr-Authentication">
                            <div style="float: left;">
                                <div class="icon" style="height: auto">
                                    <img src="@Url.Content("~/Content/Images/nav10.png")" style="width:20px;height:20px;margin-top:4px">
                                </div>
                                <div class="text">权限设置</div>
                            </div>
                            <div class="dropdown-icon">
                                <img src="@Url.Content("~/Content/Images/dropdown-icon.png")"/>
                            </div>
                            <div class="dropdown-data">
                                <i></i><span></span>
                                <ul>
                                    <li id="lr-RoleUser" onclick="btn_Member();">
                                        <img src="@Url.Content("~/Content/Images/Icon16/xfn.png")">角色用户</li>
                                    <li id="lr-RoleUserBatch" onclick="btn_MemberBatch()">
                                        <img src="@Url.Content("~/Content/Images/Icon16/group_go.png")">角色用户批量</li>
                                    <li id="lr-RolePermission" onclick="btn_AllotPermission();">
                                        <img src="@Url.Content("~/Content/Images/Icon16/group_key.png")">角色权限</li>
                                </ul>
                            </div>
                        </a>

                        <a title="关闭当前窗口(Esc)" class="tools_btn" id="lr-leave" onclick="btn_back()"><span><b style="background: url('@Url.Content("~/Content/Images/nav6.png")') 50% 8px no-repeat;background-size:18px 18px;-ms-behavior: url('@Url.Content("~/Content/Images/backgroundsize.min.htc")');behavior:url('@Url.Content("~/Content/Images/backgroundsize.min.htc")');">返回</b></span></a>
                    </div>
                </div>
                <table id="gridTable"></table>
            </div>
        </div>
    </div>
</body>
</html>

<script type="text/javascript">
    $(document).ready(function () {
        GetTree();
        GetGrid();
        PartialButton();
    });

    //离开
    function btn_back() {
        AddTabMenu('homebox', '@Url.Content("~/HomeIndex/OfficeRight")');
    }

    var companyId, companyName = "";
    //加载左侧单位树
    function GetTree() {
        var itemtree = {
            onnodeclick: function (item) {
                companyId = item.id;            //单位ID
                companyName = item.text;        //单位名称
                var url = '@Url.Action("GridListJson", "Role")?companyId=' + companyId;
                $("#CenterTitle").html(" - " + companyName);
                $("#gridTable").jqGrid('setGridParam', { url: url }).trigger('reloadGrid');
            },
            url: '@Url.Action("TreeJson", "Company")'
        };
        $("#ItemsTree").treeview(itemtree);
    }

    //加载数据表格

    function GetGrid() {
        $("#gridTable").jqGrid({
            url: '@Url.Action("GridListJson", "Role")',
            datatype: "json",
            treeGrid: false,
            height: $(window).height() - 105,
            autowidth: true,
            colModel: [
                { label: '主键', name: 'Id', index: 'Id', width: 80, hidden: true },
                { label: '编码', name: 'Code', index: 'Code', width: 80 },
                { label: '角色', name: 'FullName', index: 'FullName', width: 200 },
                {
                    label: '成员人数',
                    name: 'Membercount',
                    index: 'Membercount',
                    width: 80,
                    align: 'center',
                    formatter: function (cellvalue, options, rowObject) {
                        return cellvalue + "个人";
                    }
                },
                { label: '所属公司Id', name: 'CompanyId', index: 'CompanyId', hidden: true },
                { label: '所属公司', name: 'CompanyName', index: 'CompanyName', width: 120 },
                {
                    label: '有效',
                    name: 'Enabled',
                    index: 'Enabled',
                    width: 45,
                    align: 'center',
                    formatter: function (cellvalue, options, rowObject) {
                        if (cellvalue === 1)
                            return "<img src='@Url.Content("~/Content/Images/checkokmark.gif")'/>";
                        if (cellvalue === 0)
                            return "<img src='@Url.Content("~/Content/Images/checknomark.gif")'/>";
                        return "<img src='@Url.Content("~/Content/Images/checknomark.gif")'/>";
                    }
                },
                { label: '描述', name: 'Remark', index: 'Remark', width: 600 }
            ],
            pager: false,
            rownumbers: true,
            rowNum: 1000,
            shrinkToFit: false,
        });
        }

        //新增
        function btn_add() {
            if (!!companyId) {
                var url = '@Url.Action("Edit", "Role")?companyId=' + companyId;
                openDialog(url, "Form", "新增角色", 450, 240, function (iframe) {
                    top.frames[iframe].AcceptClick();
                });
            } else {
                alertDialog("请先选择左边的单位", 0);
            }
        }

        //编辑
        function btn_edit() {
            var keyValue = GetJqGridRowValue("#gridTable", "Id");
            if (IsChecked(keyValue)) {
                var url = '@Url.Action("Edit", "Role")?roleId=' + keyValue;
                openDialog(url, "Form", "编辑角色", 450, 240, function (iframe) {
                    top.frames["Form"].AcceptClick();
                });
            }
        }

        //明细
        function btn_detail() {
            var keyValue = GetJqGridRowValue("#gridTable", "Id");
            if (IsChecked(keyValue)) {
                var url = '@Url.Action("Edit", "Role")?roleId=' + keyValue;
                Dialog(url, "Detail", "角色明细", 450, 240);
            }
        }

        //删除
        function btn_delete() {
            var keyValue = GetJqGridRowValue("#gridTable", "Id");
            if (IsDelData(keyValue)) {
                var delparm = 'roleId=' + keyValue;
                delConfig('@Url.Action("DeleteRole", "Role")', delparm, keyValue.split(",").length);
            }
        }

        //角色用户
        function btn_Member() {
            var roleId = GetJqGridRowValue("#gridTable", "Id");
            var roleName = GetJqGridRowValue("#gridTable", "FullName");
            var companyId = GetJqGridRowValue("#gridTable", "CompanyId");
            var companyName = GetJqGridRowValue("#gridTable", "CompanyName");
            if (IsChecked(roleId)) {
                var url = "@Url.Action("AllotMember", "Permission")?ObjectId=" + roleId + '&CompanyId=' + companyId + '&CompanyName=' + escape(companyName) + '&Category=2';
                openDialog(url, "AllotMember", "角色用户", 820, 400, function (iframe) {
                    top.frames["AllotMember"].AcceptClick();
                });
            }
        }

        //角色用户批量
        function btn_MemberBatch() {
            var url = "@Url.Action("AllotMemberBatch", "Permission")?Category=2&CategoryName=" + escape('角色');
            openDialog(url, "AllotMember", "角色用户批量设置", 820, 400, function (iframe) {
                top.frames["AllotMember"].AcceptClick();
            });
        }

        //角色权限
        function btn_AllotPermission() {
            var roleId = GetJqGridRowValue("#gridTable", "Id");
            var roleName = GetJqGridRowValue("#gridTable", "FullName");
            if (IsChecked(roleId)) {
                var width = $(window).width();
                width = width - (width * 0.2);
                var height = $(window).height();
                var url = "@Url.Action("AllotPermission", "Permission")?id=" + roleId + '&type=role&rnd=' + Math.random();

                top.$.dialog({
                    id: "AllotPermission", width: width, height: height, lock: true, max: false, resize: false, extendDrag: true,
                    title: "角色权限-" + roleName,
                    content: 'url:' + url,
                    button: [
                        {
                            name: '保存权限设置',
                            className: 'green',
                            callback: function () {
                                top.frames["AllotPermission"].AcceptClick();
                            }
                        }, { name: '关 闭' }
                    ]
                });
            }
        }

        //刷新
        function windowload() {
            $("#gridTable").trigger("reloadGrid"); //重新载入  
        }

</script>
